From 0b987d55f3124509448d43626b8c7c3898606687 Mon Sep 17 00:00:00 2001
From: Miguel Borges de Freitas <92enen@gmail.com>
Date: Tue, 21 Feb 2023 21:55:56 +0000
Subject: [PATCH] [upnp] fix regressions for folder definitions

---
 xbmc/network/upnp/UPnPServer.cpp | 26 +++++++++++++++++++++++++-
 1 file changed, 25 insertions(+), 1 deletion(-)

diff --git a/xbmc/network/upnp/UPnPServer.cpp b/xbmc/network/upnp/UPnPServer.cpp
index 09079e4769..8e8432e406 100644
--- a/xbmc/network/upnp/UPnPServer.cpp
+++ b/xbmc/network/upnp/UPnPServer.cpp
@@ -272,8 +272,9 @@ PLT_MediaObject* CUPnPServer::Build(const std::shared_ptr<CFileItem>& item,
 
     m_logger->debug("Preparing upnp object for item '{}'", (const char*)path);
 
-    if (path == "virtualpath://upnproot") {
+    if (path.StartsWith("virtualpath://upnproot")) {
         path.TrimRight("/");
+        item->m_bIsFolder =  true;
         if (path.StartsWith("virtualpath://")) {
             object = new PLT_MediaContainer;
             object->m_Title = item->GetLabel().c_str();
@@ -331,6 +332,11 @@ PLT_MediaObject* CUPnPServer::Build(const std::shared_ptr<CFileItem>& item,
                     }
                 }
 
+                // all items appart from songs (artists, albums, etc) are folders
+                if (!item->HasMusicInfoTag() || item->GetMusicInfoTag()->GetType() != MediaTypeSong)
+                {
+                    item->m_bIsFolder = true;
+                }
 
                 if (item->GetLabel().empty()) {
                     /* if no label try to grab it from node type */
@@ -380,6 +386,11 @@ PLT_MediaObject* CUPnPServer::Build(const std::shared_ptr<CFileItem>& item,
                     item->GetVideoInfoTag()->m_iEpisode = (int)item->GetProperty("totalepisodes").asInteger();
                     item->GetVideoInfoTag()->SetPlayCount(static_cast<int>(item->GetProperty("watchedepisodes").asInteger()));
                 }
+                // if this is an item in the library without a playable path it most be a folder
+                else if (item->GetVideoInfoTag()->m_strFileNameAndPath.empty())
+                {
+                    item->m_bIsFolder = true;
+                }
 
                 // try to grab title from tag
                 if (item->HasVideoInfoTag() && !item->GetVideoInfoTag()->m_strTitle.empty()) {
@@ -397,8 +408,21 @@ PLT_MediaObject* CUPnPServer::Build(const std::shared_ptr<CFileItem>& item,
                 }
             }
         }
+        // playlists are folders
+        else if (item->IsPlayList())
+        {
+            item->m_bIsFolder = true;
+        }
+        // audio and not a playlist -> song, so it's not a folder
+        else if (item->IsAudio())
+        {
+            item->m_bIsFolder = false;
+        }
+        // any other type of item -> delegate to CDirectory
         else
+        {
             item->m_bIsFolder = CDirectory::Exists(item->GetPath());
+        }
 
         // not a virtual path directory, new system
         object = BuildObject(*item.get(), file_path, with_count, thumb_loader, &context, this, UPnPContentDirectory);
-- 
2.39.2

